# frozen_string_literal: true

module StillActive
  module VulnerabilityHelper
    extend self

    SEVERITY_ORDER = ["low", "medium", "high", "critical"].freeze

    def highest_severity(vulnerabilities)
      return if vulnerabilities.nil? || vulnerabilities.empty?

      max_score = vulnerabilities.filter_map { |v| v[:cvss3_score] || v[:cvss2_score] }.max
      return if max_score.nil?

      severity_label(max_score)
    end

    def severity_at_or_above?(vulnerabilities, threshold)
      highest = highest_severity(vulnerabilities)
      return false if highest.nil?

      SEVERITY_ORDER.index(highest) >= SEVERITY_ORDER.index(threshold)
    end

    private

    def severity_label(score)
      case score
      when 9.0..Float::INFINITY then "critical"
      when 7.0...9.0 then "high"
      when 4.0...7.0 then "medium"
      else "low"
      end
    end
  end
end
