# frozen_string_literal: true

RSpec.describe(StillActive::VulnerabilityHelper) do
  describe(".highest_severity") do
    it("returns nil for nil input") do
      expect(described_class.highest_severity(nil)).to(be_nil)
    end

    it("returns nil for empty array") do
      expect(described_class.highest_severity([])).to(be_nil)
    end

    it("returns critical for cvss3 score >= 9.0") do
      vulns = [{ cvss3_score: 9.8 }]
      expect(described_class.highest_severity(vulns)).to(eq("critical"))
    end

    it("returns high for cvss3 score 7.0-8.9") do
      vulns = [{ cvss3_score: 7.5 }]
      expect(described_class.highest_severity(vulns)).to(eq("high"))
    end

    it("returns medium for cvss3 score 4.0-6.9") do
      vulns = [{ cvss3_score: 5.0 }]
      expect(described_class.highest_severity(vulns)).to(eq("medium"))
    end

    it("returns low for cvss3 score < 4.0") do
      vulns = [{ cvss3_score: 2.0 }]
      expect(described_class.highest_severity(vulns)).to(eq("low"))
    end

    it("falls back to cvss2 score when cvss3 is nil") do
      vulns = [{ cvss3_score: nil, cvss2_score: 8.5 }]
      expect(described_class.highest_severity(vulns)).to(eq("high"))
    end

    it("prefers cvss3 when both scores are present") do
      vulns = [{ cvss3_score: 9.0, cvss2_score: 5.0 }]
      expect(described_class.highest_severity(vulns)).to(eq("critical"))
    end

    it("uses highest score across mixed v2/v3 vulnerabilities") do
      vulns = [
        { cvss3_score: nil, cvss2_score: 9.5 },
        { cvss3_score: 3.0, cvss2_score: nil },
      ]
      expect(described_class.highest_severity(vulns)).to(eq("critical"))
    end

    it("returns nil when all scores are nil") do
      vulns = [{ cvss3_score: nil, cvss2_score: nil }]
      expect(described_class.highest_severity(vulns)).to(be_nil)
    end
  end
end
